---
output: html_document
---
# パネル分析
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## データ
```{r}
library(plm)
data("Grunfeld", package="plm")
head(Grunfeld)
```


## プーリングOLS
$$
inv_{it} = \beta_0 + \beta_1 value_{it} + \beta_2 capital_{it} + u_{it}
$$

誤差項 $u_{it}$ は $i$ についても $t$ についても独立同一分布と仮定する.
さらに誤差項は説明変数と独立である.

この推計は以下のようにする.
```{r}
gp <- plm(inv ~ value + capital, data = Grunfeld, model = "pooling")
summary(gp)
```

これは以下の回帰分析と同じである.
```{r}
summary(lm(inv ~ value + capital, data = Grunfeld))
```

## 固定効果モデル
次のモデルを考える.
$$
inv_{it} = \beta_1 value_{it} + \beta_2 capital_{it} +\alpha_i + u_{it}
$$
この $\alpha_i$ は固定効果と呼ばれている.
$\alpha_i$ は時間 $t$ に対して一定である.
$\alpha_i$ は誤差項と相関があるもしれない.

この推計は以下のようにする.
```{r}
gi <- plm(inv ~ value + capital, data = Grunfeld, model = "within")
summary(gi)
```

固定効果は以下のコマンドで確かめられる.
```{r}
fixef(gi)
```

これは以下の回帰分析と同じである.
```{r}
summary(lm(inv ~ value + capital+0+factor(firm), data = Grunfeld))
```
決定係数が大きく異なっていることに注意されたい.

次のモデルを考える.
$$
inv_{it} = \beta_1 value_{it} + \beta_2 capital_{it}+ \gamma_t +\alpha_i + u_{it}
$$
この $\gamma_t$ は時間効果と呼ばれている.

この推計は以下のようにする.
```{r}
gt <- plm(inv ~ value + capital, data = Grunfeld, effect="twoways",model = "within")
summary(gt)
```

これは以下の回帰分析と同じである.
```{r}
summary(lm(inv ~ value + capital+0+factor(firm)+factor(year), data = Grunfeld))
```
決定係数が大きく異なっていることに注意されたい.

時間効果が有効かどうかはワルド検定を実施する.
```{r}
git<-update(gi,.~.+factor(year))
library(lmtest)
waldtest(gi,git)
```


## 固定効果VSプーリングOLS
帰無仮説が固定効果, 対立仮説が固定効果モデルの検定は以下のコマンドを実行すればよい.
```{r}
pFtest(gi,gp)
```

時間効果モデルの場合は次のようにする.
```{r}
gpt <- plm(inv ~ value + capital + factor(year), data = Grunfeld, model = "pooling")
pFtest(gt,gpt)
```

## 変量効果モデル
この $\alpha_i$ は変量効果効果と呼ばれている.
$\alpha_i$ は時間 $t$ に対して一定でなく独立同一分布の確率変数にしたがう.
さらに $\alpha_i$ は説明変数と無相関であることが必要である.

変量効果モデルは次のコマンドで実施する.
```{r}
gr <- plm(inv ~ value + capital, data = Grunfeld, model = "random")
summary(gr)
```

時間効果のある変量モデルとは次のコマンドを実施する.
```{r}
grt <- plm(inv ~ value + capital + factor(year), data = Grunfeld, model = "random")
summary(grt)
```

時間効果が有意かどうかは次の検定を実施すれば良い.
```{r}
waldtest(gr,grt)
```

## ハウスマン検定
帰無仮説が変量効果モデル, 対立仮説が固定効果モデルの検定はハウスマン検定を実施する.
ハウスマン検定は以下で実施する.
```{r}
phtest(gi,gr)
```

時間効果がある場合以下を実行すればよい.
```{r}
phtest(gt,grt)
```

## 分散不均一の検定
分散不均一かどうかは時間効果がない場合, 以下のようにすればよい.
```{r}
bptest(inv ~ value + capital + factor(firm), data=Grunfeld)
```

分散不均一が疑われる場合, クラスターロバスト分散を用いる.
```{r}
coeftest(gi,vcov=vcovHC(gi,type="sss"))
```

分散不均一かどうかは時間効果がある場合, 以下のようにすればよい.
```{r}
bptest(inv ~ value + capital + factor(firm) + factor(year),data=Grunfeld)
```

分散不均一が疑われる場合, クラスターロバスト分散を用いる.
```{r}
coeftest(gt,vcov=vcovHC(gt,type="sss"))
```

また次のようにしても求められる.
```{r}
coeftest(git,vcov=vcovHC(git,type="HC1",cluster = "group"))
```




