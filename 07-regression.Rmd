---
output: html_document
---

# 回帰分析
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse=TRUE)
```

仮想的に以下のようにデータを生成する.
```{r}
N <- 100
x<-runif(N)
w<-sample(c("H","T"),N,replace=TRUE)
y <- 10 + 2*x + ifelse(w=="H",1,0) + rnorm(N)
df <- data.frame(w,x,y)
```

## 単回帰モデル
次の単回帰モデルを考えてる.
$x$ は説明変数で, 
$y$ は被説明変数である.
$u$ は誤差項である.
パラメータとして $\alpha$ は切片パラメータ, $\beta$ は傾きパラメータである.

$$
y = \alpha + \beta x + u
$$

R で回帰分析を実施するには `lm` を実施する.
```{r}
fm <- lm(y ~ x, data=df)
```

`fm` 自体はリストであり, 以下の要素がある.
```{r}
typeof(fm)
names(fm)
```

係数は次のコマンドを実施する.
```{r}
coef(fm)
# coefficients(fm)
```

残差は次のコマンドを実施する.
```{r}
head(resid(fm))
# residuals(fm)
# with(fm, residuals)
```

予測値は次のコマンドを実施する.
```{r}
head(fitted(fm))
# fitted.values(fm)
# with(fm, fitted.values)
```

残差自乗和は次のコマンドを実施する.
```{r}
deviance(fm)
sum(resid(fm)^2)
```

### ティー検定
その結果を見るには `summary` を実施する.
```{r}
summary(fm)
```

これをみれば各変数の係数がゼロのティー検定も可能である.
他にも, 残差標準誤差, 決定係数, 修正済み決定係数, 全ての係数がゼロであるF検定も可能である.


`summary(fm)` もリストであり, それぞれの要素は以下である.
```{r}
typeof(summary(fm))
names(summary(fm))
```

単なる `fm` と同じ名前もあるが, 中身が違っている場合もある.
例えば `residuals` は同じであるが, 係数はより情報が加わっている.
```{r}
coef(summary(fm))
# coefficients(summary(fm))
```

残差の標準誤差
```{r}
sqrt(deviance(fm)/df.residual(fm))
with(summary(fm),sigma)
```

決定係数は次のようにして計算する.
```{r}
1-deviance(fm)/with(df, sum((y-mean(y))^2))
with(summary(fm),r.squared)
```

調整済み決定係数は次のようにして計算する.
```{r}
1-(deviance(fm)/df.residual(fm))/with(df, sum((y-mean(y))^2/(nrow(df)-1)))
with(summary(fm),adj.r.squared)
```



### 対数変換
次のモデルを考える.
$$
y = \alpha + \beta \log(x) + u
$$

対数変換をおこなう場合, `log` を用いるとよい.
```{r}
fm <- lm(y~log(x),data=df)
summary(fm)
```

### 切片なし回帰モデル
次のモデルを考える.
$$
y = \beta x + u
$$

切片なしモデルを推定したい場合は次のように `-1` とする.
```{r}
fm <- lm(y~x-1,data=df)
summary(fm)
```

## 重回帰モデル
説明変数として $w$ を加えたモデルを考える.
$$
y = \alpha + \beta x +\gamma w+ u
$$

説明変数を加えたいときには `+` と変数名を使うことができる. 
```{r}
fm <- lm(y~x+w,data=df)
summary(fm)
```

R の特徴は因子もとくに変換することなくダミー変数として扱える.

### 自乗項
説明変数として自乗項を加えたモデルを考える.
$$
y = \alpha + \beta x + \gamma x^2 + u
$$


```{r}
fm <- lm(y~x+I(x^2),data=df)
summary(fm)
```

### 交差項
説明変数として交差項を加えたモデルを考える.
$$
y = \alpha + \beta x + \gamma w + \delta xw + u
$$

説明変数 `x` と `w`の自乗項は自乗項は `x:w` である.
```{r}
fm<-lm(y~x+w+x:w,data=df)
summary(fm)
```

もしくは以下のように `*` を使って簡便的に表せる.
```{r}
fm <- lm(y~x*w,data=df)
summary(fm)
```

### エフ検定
今, 帰無仮説が
$$
y = \alpha + \beta x + u
$$
で, 対立仮説が
$$
y = \alpha + \beta x + \gamma w + \delta xw + u
$$
となる検定を実施したい. 

これは複数の係数がゼロであるエフ検定である.
コマンド `anova` を用いればエフ検定できる.
```{r}
fm0 <- lm(y~x,data=df)
fm1 <- lm(y~x*w,data=df)
anova(fm0,fm1)
```

順番を変えても, 検定統計量自体に変更はない.
```{r}
anova(fm1,fm0)
```

またモデルの更新として `update` を使えば簡単になる場合もある.
```{r}
fm1 <- update(fm0, .~. +w + w:x)
anova(fm0,fm1)
```

